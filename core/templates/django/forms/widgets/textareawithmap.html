<textarea name="{{ widget.name }}"{% include "django/forms/widgets/attrs.html" %}>
{% if widget.value %}{{ widget.value }}{% endif %}</textarea>

<div id="map" class="container">

    <style>
        #map {
            width: 100%;
            height: 500px;
            margin-top: 20px;
        }
    </style>

     <script>
        let map;
        let placemark;

        ymaps.ready(function () {
            map = new ymaps.Map("map", {
                center: [55.7518, 37.6195],
                zoom: 10
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞
            const addressField = document.getElementById('id_cafe.address');
            addressField.addEventListener('keydown', onInputKeyDown);
            addressField.addEventListener('blur', onInputBlur);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            map.events.add('click', function (e) {
                const coords = e.get('coords');
                reverseGeocode(coords);     // üîÅ –û–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
                updatePlacemark(coords);    // üìç –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
            });

            // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–æ—Ä–º—ã
            if (addressField.value.trim()) {
                findAddress();
            }
        });

        function onInputKeyDown(e) {
            if (e.key === 'Enter') {
                findAddress();
            }
        }

        function onInputBlur() {
            findAddress();
        }

        function findAddress() {
            const address = document.getElementById("id_cafe.address")?.value.trim();

            if (!address) {
                alert("–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å");
                return;
            }

            ymaps.geocode(address).then(function (res) {
                if (res.geoObjects.getLength() > 0) {
                    const coords = res.geoObjects.get(0).geometry.getCoordinates();
                    map.setCenter(coords, 15);
                    handleMapClick(coords);
                } else {
                    alert("–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω");
                }
            }).catch(function (err) {
                console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–∞:", err);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∞–¥—Ä–µ—Å");
            });
        }

        function handleMapClick(coords) {
            updateCoordinates(coords);
            updatePlacemark(coords);
        }

        function updatePlacemark(coords) {
            const cafename = document.getElementById("id_cafe.title")?.value || "–ö–∞—Ñ–µ";

            if (placemark) {
                map.geoObjects.remove(placemark);
            }

            placemark = new ymaps.Placemark(
                coords,
                {
                    balloonContent: cafename
                },
                {
                    preset: "islands#violetStretchyIcon"
                }
            );

            map.geoObjects.add(placemark);
        }

        function updateCoordinates(coords) {
            ymaps.geocode(coords).then(function (res) {
                if (res.geoObjects.getLength() > 0) {
                    const address = res.geoObjects.get(0).getAddressLine();
                    const addressInput = document.getElementById('id_cafe.address');
                    if (addressInput) {
                        addressInput.value = address;
                    }
                }
            }).catch(function (err) {
                console.error("–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:", err);
            });
        }

        // üî• –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–¥–µ—Å—å
        function reverseGeocode(coords) {
            ymaps.geocode(coords).then(function (res) {
                if (res.geoObjects.getLength() > 0) {
                    const address = res.geoObjects.get(0).getAddressLine();
                    const addressInput = document.getElementById('id_cafe.address');
                    if (addressInput) {
                        addressInput.value = address;
                    }
                }
            }).catch(function (err) {
                console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:", err);
            });
        }
    </script>

{#    <script>    #}
{#        ymaps.ready(init);#}
{#        function init() {#}
{#        var myMap = new ymaps.Map('map', {#}
{#            center: [55.753994, 37.622093],#}
{#            zoom: 9#}
{#        });#}
{#    #}
{#        // –ü–æ–∏—Å–∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç #}
{#        ymaps.geocode('–≥.–ö–æ—Å—Ç—Ä–æ–º–∞, —É–ª. –°–æ–≤–µ—Ç—Å–∫–∞—è, 47', {#}
{#            /**#}
{#             * –û–ø—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞#}
{#             * @see https://api.yandex.ru/maps/doc/jsapi/2.1/ref/reference/geocode.xml#}
{#             */#}
{#            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –æ–∫–Ω–∞ –∫–∞—Ä—Ç—ã.#}
{#            // boundedBy: myMap.getBounds(),#}
{#            // strictBounds: true,#}
{#            // –í–º–µ—Å—Ç–µ —Å –æ–ø—Ü–∏–µ–π boundedBy –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å —Å—Ç—Ä–æ–≥–æ –≤–Ω—É—Ç—Ä–∏ –æ–±–ª–∞—Å—Ç–∏, —É–∫–∞–∑–∞–Ω–Ω–æ–π –≤ boundedBy.#}
{#            // –ï—Å–ª–∏ –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —ç–∫–æ–Ω–æ–º–∏–º —Ç—Ä–∞—Ñ–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.#}
{#            results: 1#}
{#        }).then(function (res) {#}
{#                // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è.#}
{#                var firstGeoObject = res.geoObjects.get(0),#}
{#                    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–µ–æ–æ–±—ä–µ–∫—Ç–∞.#}
{#                    coords = firstGeoObject.geometry.getCoordinates(),#}
{#                    // –û–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≥–µ–æ–æ–±—ä–µ–∫—Ç–∞.#}
{#                    bounds = firstGeoObject.properties.get('boundedBy');#}
{#    #}
{#                firstGeoObject.options.set('preset', 'islands#darkBlueDotIconWithCaption');#}
{#                // –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –∞–¥—Ä–µ—Å–æ–º –∏ –≤—ã–≤–æ–¥–∏–º –≤ –∏–∫–æ–Ω–∫–µ –≥–µ–æ–æ–±—ä–µ–∫—Ç–∞.#}
{#                firstGeoObject.properties.set('iconCaption', firstGeoObject.getAddressLine());#}
{#    #}
{#                // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π –≥–µ–æ–æ–±—ä–µ–∫—Ç –Ω–∞ –∫–∞—Ä—Ç—É.#}
{#                myMap.geoObjects.add(firstGeoObject);#}
{#                // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≥–µ–æ–æ–±—ä–µ–∫—Ç–∞.#}
{#                myMap.setBounds(bounds, {#}
{#                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–∞–π–ª–æ–≤ –Ω–∞ –¥–∞–Ω–Ω–æ–º –º–∞—Å—à—Ç–∞–±–µ.#}
{#                    checkZoomRange: true#}
{#                });#}
{#    #}
{#                /**#}
{#                 * –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ javascript-–æ–±—ä–µ–∫—Ç–∞.#}
{#                 */#}
{#                console.log('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –≥–µ–æ–æ–±—ä–µ–∫—Ç–∞: ', firstGeoObject.properties.getAll());#}
{#                /**#}
{#                 * –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ—Ç–≤–µ—Ç–∞ –≥–µ–æ–∫–æ–¥–µ—Ä–∞.#}
{#                 * @see https://api.yandex.ru/maps/doc/geocoder/desc/reference/GeocoderResponseMetaData.xml#}
{#                 */#}
{#                console.log('–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞ –≥–µ–æ–∫–æ–¥–µ—Ä–∞: ', res.metaData);#}
{#                /**#}
{#                 * –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≥–µ–æ–∫–æ–¥–µ—Ä–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞.#}
{#                 * @see https://api.yandex.ru/maps/doc/geocoder/desc/reference/GeocoderMetaData.xml#}
{#                 */#}
{#                console.log('–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≥–µ–æ–∫–æ–¥–µ—Ä–∞: ', firstGeoObject.properties.get('metaDataProperty.GeocoderMetaData'));#}
{#                /**#}
{#                 * –¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ (precision) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–º–æ–≤.#}
{#                 * @see https://api.yandex.ru/maps/doc/geocoder/desc/reference/precision.xml#}
{#                 */#}
{#                console.log('precision', firstGeoObject.properties.get('metaDataProperty.GeocoderMetaData.precision'));#}
{#                /**#}
{#                 * –¢–∏–ø –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (kind).#}
{#                 * @see https://api.yandex.ru/maps/doc/geocoder/desc/reference/kind.xml#}
{#                 */#}
{#                console.log('–¢–∏–ø –≥–µ–æ–æ–±—ä–µ–∫—Ç–∞: %s', firstGeoObject.properties.get('metaDataProperty.GeocoderMetaData.kind'));#}
{#                console.log('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞: %s', firstGeoObject.properties.get('name'));#}
{#                console.log('–û–ø–∏—Å–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞: %s', firstGeoObject.properties.get('description'));#}
{#                console.log('–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞: %s', firstGeoObject.properties.get('text'));#}
{#                /**#}
{#                * –ü—Ä—è–º—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è.#}
{#                * @see https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/GeocodeResult-docpage/#getAddressLine#}
{#                */#}
{#                console.log('\n–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ: %s', firstGeoObject.getCountry());#}
{#                console.log('–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç: %s', firstGeoObject.getLocalities().join(', '));#}
{#                console.log('–ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞: %s', firstGeoObject.getAddressLine());#}
{#                console.log('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–¥–∞–Ω–∏—è: %s', firstGeoObject.getPremise() || '-');#}
{#                console.log('–ù–æ–º–µ—Ä –∑–¥–∞–Ω–∏—è: %s', firstGeoObject.getPremiseNumber() || '-');#}
{#    #}
{#                /**#}
{#                 * –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –≥–µ–æ–∫–æ–¥–µ—Ä–æ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –º–µ—Ç–∫—É —Å–æ —Å–≤–æ–∏–º–∏ —Å—Ç–∏–ª—è–º–∏ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –±–∞–ª—É–Ω–∞, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –º–µ—Ç–∫—É –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–µ –Ω–∞ –∫–∞—Ä—Ç—É –≤–º–µ—Å—Ç–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–π.#}
{#                 */#}
{#                /**#}
{#                 var myPlacemark = new ymaps.Placemark(coords, {#}
{#                 iconContent: '–º–æ—è –º–µ—Ç–∫–∞',#}
{#                 balloonContent: '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–∞–ª—É–Ω–∞ <strong>–º–æ–µ–π –º–µ—Ç–∫–∏</strong>'#}
{#                 }, {#}
{#                 preset: 'islands#violetStretchyIcon'#}
{#                 });#}
{#    #}
{#                 myMap.geoObjects.add(myPlacemark);#}
{#                 */#}
{#            });#}
{#        }#}
{#    </script>#}
    
</div>
