<textarea name="{{ widget.name }}"{% include "django/forms/widgets/attrs.html" %}>
{% if widget.value %}{{ widget.value }}{% endif %}</textarea>

<div id="map" class="container">

    <style>
        #map {
            width: 100%;
            height: 500px;
            margin-top: 20px;
        }
    </style>

     <script>
        let map;
        let placemark;

        ymaps.ready(function () {
            map = new ymaps.Map("map", {
                center: [55.7518, 37.6195],
                zoom: 10
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞
            const addressField = document.getElementById('id_cafe.address');
            addressField.addEventListener('keydown', onInputKeyDown);
            addressField.addEventListener('blur', onInputBlur);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            map.events.add('click', function (e) {
                const coords = e.get('coords');
                reverseGeocode(coords);     // üîÅ –û–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
                updatePlacemark(coords);    // üìç –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
            });

            // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–æ—Ä–º—ã
            if (addressField.value.trim()) {
                findAddress();
            }
        });

        function onInputKeyDown(e) {
            if (e.key === 'Enter') {
                findAddress();
            }
        }

        function onInputBlur() {
            findAddress();
        }

        function findAddress() {
            const address = document.getElementById("id_cafe.address")?.value.trim();

            if (!address) {
                alert("–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å");
                return;
            }

            ymaps.geocode(address).then(function (res) {
                if (res.geoObjects.getLength() > 0) {
                    const coords = res.geoObjects.get(0).geometry.getCoordinates();
                    map.setCenter(coords, 15);
                    handleMapClick(coords);
                } else {
                    alert("–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω");
                }
            }).catch(function (err) {
                console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–∞:", err);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∞–¥—Ä–µ—Å");
            });
        }

        function handleMapClick(coords) {
            updateCoordinates(coords);
            updatePlacemark(coords);
        }

        function updatePlacemark(coords) {
            const cafename = document.getElementById("id_cafe.title")?.value || "–ö–∞—Ñ–µ";

            if (placemark) {
                map.geoObjects.remove(placemark);
            }

            placemark = new ymaps.Placemark(
                coords,
                {
                    balloonContent: cafename
                },
                {
                    preset: "islands#violetStretchyIcon"
                }
            );

            map.geoObjects.add(placemark);
        }

        function updateCoordinates(coords) {
            ymaps.geocode(coords).then(function (res) {
                if (res.geoObjects.getLength() > 0) {
                    const address = res.geoObjects.get(0).getAddressLine();
                    const addressInput = document.getElementById('id_cafe.address');
                    if (addressInput) {
                        addressInput.value = address;
                        // addressInput.dispatchEvent(new Event('change', { bubbles: true }));
                        // addressInput.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                }
            }).catch(function (err) {
                console.error("–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:", err);
            });
        }

        // üî• –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–¥–µ—Å—å
        function reverseGeocode(coords) {
            ymaps.geocode(coords).then(function (res) {
                if (res.geoObjects.getLength() > 0) {
                    const address = res.geoObjects.get(0).getAddressLine();
                    const addressInput = document.getElementById('id_cafe.address');
                    if (addressInput) {
                        addressInput.value = address;
                        // addressInput.dispatchEvent(new Event('change', { bubbles: true }));
                        // addressInput.dispatchEvent(new Event('input', { bubbles: true }));
                        addressInput.focus();
                    }
                }
            }).catch(function (err) {
                console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:", err);
            });
        }
    </script>

</div>
